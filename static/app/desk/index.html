<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>我的电脑</title>
		<script type="text/javascript" src="../../js/vue.js" ></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script src="app.js"></script>
		<link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
		<link href="app.css" rel="stylesheet">
		<style>
		*{
			margin: 0px;
			padding: 0px;
		}
		</style>
	</head>
	<body>
		<Toast class="toast" :text="msg" :display="display" :color="color" :background="background"></Toast>
		<div class="listFile">
			<div v-if="success" class="container contain">

				<div class="row">
					<div class="col-md-4 col-lg-4 col-sm-4">文件名称</div>
					<div class="col-md-4 col-lg-4 col-sm-4  visible-lg-block visible-md-block">修改时间</div>
					<div class="col-md-4 col-lg-4 col-sm-4  visible-lg-block visible-md-block">大小</div>
				</div>

				<div v-for="(item,index) in fileList" @dblclick="selectFile(index)" @click="select(index)" @contextmenu.prevent="popmenu"  v-bind:class="{item:true,row:true,item_seleted:item.seleted}"> 
						<div class="col-md-4 col-lg-4 col-sm-4 text">
								<img style="width:30px;height:30px;" v-bind:src="item.img">
								<span >{{item.name}}</span>
						</div>
						<div class="col-md-4 col-lg-4 col-sm-4  visible-lg-block visible-md-block">{{item.time}}</div>
						<div class="col-md-4 col-lg-4 col-sm-4  visible-lg-block visible-md-block" >{{item.size}}</div>
				</div>
			</div>
			<template v-else>
				<div class="error">{{message}}</div>
			</template>
		</div>

		<div class="pop_menu" v-bind:style="{display:display,left:x,top:y}">
			<ul>
				<li v-for="(item,indexp) in list" >
					
					<template v-if="item.list">
							<div >{{item.name}}</div>
						<span class="more"></span>
						<ul>
							<li v-for="(item2,index2) in item.list" ><div @click.prevent="selectMenu(indexp,index2)" >{{item2.name}}</div></li>
						</ul>
					</template>
					<template v-else>
							<div @click.prevent="selectMenu(indexp,-1)">{{item.name}}</div>
					</template>
				</li>
			</ul>
		</div>
    
	</body>
	<script>
	
	var popMenu=null;
	var fileList=null;
	var toast=null;
	fileList=new Vue({
		el:'.listFile',
		data:{
			fileList:[],
			path:'/',
			success:false,
			message:'',
		},
		created:function() {
			var that=this;
			this.load({name:this.path});
		},
		methods: {
			//加载文件
			load:function(param){
				var that=this;
				axios({
						method:'post',
						url:'/file/list.do',
						timeout: 1000,
						params:param,
						//请求头
						headers:{
							'custome-header': 'miaov',
						}
				}).then(function(res){
					var data=res.data;
					that.message=data.message;
					if(data.success==0){
						that.success=true;
						for(var i=0;i<data.data.length;i++){
							data.data[i].seleted=false;
							if(data.data[i].isDir){
								data.data[i].img="/icon/folder.png"
							}else{
								data.data[i].img="/icon/file.png"
							}
						}
						that.path=param.name;
						that.fileList=data.data;
						//添加返回列
						if(true){
							var parent={
								name:'上级目录',
								img:'/icon/folder.png',
								selected:false,
								isDir:true,
								back:true,
							};
							that.fileList.unshift(parent);
						}
					}else{
						that.success=false;
					}
				});
			},
			//双击选择
			selectFile:function(index){
				var item=this.fileList[index];
				var that=this;
				if(item.back){
					var path=this.path;
					path=path.substring(0, path.lastIndexOf('/'));
					path=path.substring(0, path.lastIndexOf('/'))+"/";
					this.load({name:path});
				}else if(item.isDir){
					this.path+=item.name+"/";
					this.load({name:this.path});
				}else{
					console.log("是文件");
					toast.show("是文件");
				}
			},
			//单击选择
			select:function(index){
				popMenu.hide();
				for(var i=0;i<this.fileList.length;i++){
					if(i==index){
						this.fileList[i].seleted=true;
					}else{
						this.fileList[i].seleted=false;
					}
					
				}
			},
			//右键菜单
			popmenu:function(e){
				var event=event||window.event;
				var x=(event.clientX)+"px";
				var y=(event.clientY)+"px";
				popMenu.show(x,y);
			},
			//删除
			delet:function(path){

				var that=this;
				axios({
						method:'post',
						url:'/file/del.do',
						timeout: 1000,
						params:{name:path},
				}).then(function(res){
					if(res.data.success==0){
						that.load({name:that.path});
					}else{
						toast.show(res.data.message);
					}
					
				});
				
			}
		},
	});

	popMenu=new Vue({
		el:'.pop_menu',
		created:function(){
			this.list=[
				{name:'打开',id:"open"},
				{name:'新建',list:[
					{name:'新建文件'},
					{name:'新建目录'},
				]},
				{name:'复制'},
				{name:'粘贴'},
				{name:'删除',id:'delete'},
		];
		},
		data:{
			display:'none',
			x:'0px',
			y:'0px',
			list:[],
		},
		methods:{
			show:function(x,y){
				this.display="block";
				this.x=x;
				this.y=y;
			},
			hide:function(){
				this.display="none";
			},
			selectMenu:function(indexp,index){
				this.hide();
				var item={};
				if(index>-1){
					item=this.list[indexp].list[index];
				}else{
					item=this.list[indexp];
				}
				if(item.id=="open"){
					for(var i=0;i<fileList.fileList.length;i++){
						if(fileList.fileList[i].seleted){
							if(fileList.fileList[i].back){
								var path=fileList.path;
								path=path.substring(0, path.lastIndexOf('/'));
								path=path.substring(0, path.lastIndexOf('/'))+"/";
								fileList.load({name:path});
							}else{
								fileList.load({name:fileList.path+fileList.fileList[i].name+"/"});
							}
							
							break;
						}
					}
					
				}
				else if(item.id=="delete"){
					for(var i=0;i<fileList.fileList.length;i++){
						if(fileList.fileList[i].seleted&&!fileList.fileList[i].back){
							fileList.delet(fileList.path+fileList.fileList[i].name);
							break;
						}
					}
					
				}
				
			}
		},
	});

	toast=new Vue({
		el:'.toast',
		data:{
			msg:'test',
			display:'none',
			color:'#FFF',
			background:'#000',
		},
		methods:{
			show:function(text,time){
				if(!time){
					time=1000;
				}
				this.msg=text;
				this.display='block';
				var that=this;
				setTimeout(function(){
					that.hide();
				}, time);
			},
			hide:function(){
				this.display='none';
			}
		}
	});
	</script>
  
</html>
